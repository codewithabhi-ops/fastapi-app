name: CD

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ secrets.PROD_URL }}   # used in UI if you want
    steps:
      - uses: actions/checkout@v4

      - name: Download image-info artifact
        uses: actions/download-artifact@v4
        with:
          name: image-info
          path: ./image

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Render task definition
        run: |
          IMAGE="${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:${{ github.sha }}"
          jq --arg IMG "$IMAGE" '.containerDefinitions[0].image=$IMG' ecs/task-definition-template.json > ecs/task-def.json

      - name: Register task definition
        run: |
          aws ecs register-task-definition \
            --cli-input-json file://ecs/task-def.json \
            --region ${{ secrets.AWS_REGION }} > taskdef-register.json

      - name: Deploy to ECS service
        run: |
          FAMILY=$(jq -r '.family' ecs/task-def.json)
          REV=$(jq -r '.taskDefinition.taskDefinitionArn' taskdef-register.json)
          aws ecs update-service --cluster ${{ secrets.ECS_CLUSTER }} --service ${{ secrets.ECS_SERVICE }} --force-new-deployment --region ${{ secrets.AWS_REGION }}

